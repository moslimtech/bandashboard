<!-- <!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>خدماتك - إدارة الأماكن والإعلانات</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* CSS مدمج داخل الملف */
        :root {
            --primary-color: #4f46e5;
            --primary-hover: #4338ca;
            --success-color: #10b981;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
            --background-color: #f8fafc;
            --card-background: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        body.dark {
            --background-color: #111827;
            --card-background: #1f2937;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --border-color: #374151;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, #6366f1 100%);
            color: white;
            padding: 1rem 0;
            box-shadow: var(--shadow-lg);
            margin-bottom: 2rem;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .auth-section {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }

        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6b7280;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-success {
            background: var(--success-color);
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: var(--error-color);
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .theme-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.5rem;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: var(--card-background);
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .tab {
            flex: 1;
            padding: 1rem;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .tab:hover {
            background: rgba(79, 70, 229, 0.1);
            color: var(--primary-color);
        }

        .tab.active {
            background: var(--primary-color);
            color: white;
        }

        /* Tab Content */
        .tab-content {
            background: var(--card-background);
            border-radius: 8px;
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        /* Status Bars */
        #placeStatusBar {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            box-shadow: var(--shadow);
        }

        #placeStatusMessage {
            margin-bottom: 10px;
            font-weight: 600;
        }

        #placeStatusButtons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .status-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .status-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .status-btn.active {
            background: rgba(255, 255, 255, 0.9);
            color: #d97706;
            font-weight: 600;
        }

        /* Subscription Status Bar - الشريط الجديد */
        #subscriptionStatusBar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        #subscriptionStatusBar .subscription-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        #subscriptionTitle {
            margin: 0 0 5px 0;
            font-size: 16px;
            font-weight: 600;
        }

        #subscriptionDetails {
            margin: 0;
            font-size: 14px;
            opacity: 0.9;
        }

        #subscriptionCountdown {
            background: rgba(255,255,255,0.2);
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 600;
            min-width: 120px;
            text-align: center;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 1rem;
            background: var(--card-background);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        /* Preview */
        .preview {
            margin-top: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .preview img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 6px;
            border: 2px solid var(--border-color);
        }

        .preview-image {
            position: relative;
            display: inline-block;
        }

        .remove-image {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--error-color);
            color: white;
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Packages Grid */
        .packages-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .pkg-card {
            background: var(--card-background);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .pkg-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .pkg-card h3 {
            margin-bottom: 1rem;
            color: var(--primary-color);
            font-size: 1.2rem;
        }

        .choose-pkg {
            width: 100%;
            margin-top: 1rem;
            padding: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
        }

        /* Ads */
        .ad-card {
            background: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow);
        }

        .ad-card h4 {
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }

        .ad-card .meta {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .ad-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .ad-images {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .ad-images img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        /* Alerts */
        .alert {
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 6px;
            font-weight: 500;
            display: none;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        body.dark .alert-success {
            background: #064e3b;
            color: #a7f3d0;
        }

        body.dark .alert-error {
            background: #7f1d1d;
            color: #fca5a5;
        }

        /* Loading */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--card-background);
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
        }

        /* Auto-locate button */
        .auto-locate-btn {
            background: var(--success-color);
            margin-top: 0.5rem;
            width: 100%;
        }

        .auto-locate-btn:hover {
            background: #059669;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                border-bottom: 1px solid var(--border-color);
            }

            .tab:last-child {
                border-bottom: none;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .packages-grid {
                grid-template-columns: 1fr;
            }

            .ad-actions {
                flex-direction: column;
            }

            #subscriptionStatusBar .subscription-content {
                flex-direction: column;
                text-align: center;
            }

            #subscriptionCountdown {
                width: 100%;
            }
        }

        /* Utility Classes */
        .text-center {
            text-align: center;
        }

        .text-success {
            color: var(--success-color);
        }

        .text-error {
            color: var(--error-color);
        }

        .mb-1 {
            margin-bottom: 0.5rem;
        }

        .mb-2 {
            margin-bottom: 1rem;
        }

        .mb-3 {
            margin-bottom: 1.5rem;
        }

        .mt-1 {
            margin-top: 0.5rem;
        }

        .mt-2 {
            margin-top: 1rem;
        }

        .mt-3 {
            margin-top: 1.5rem;
        }
    </style>
</head>
<body>

    <div id="loading">
        <div class="spinner"></div>
    </div>


    <header class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-store"></i>
                خدماتك
            </div>
            <div class="auth-section">
                <button id="themeToggleBtn" class="theme-toggle" title="تغيير المظهر">
                    <i id="themeIcon" class="fas fa-moon"></i>
                    <span id="themeLabel" style="display: none;">الوضع الليلي</span>
                </button>
                <div id="loggedInUser" class="user-info" style="display: none;">
                    <i class="fas fa-user"></i>
                    <span></span>
                </div>
                <button id="loginBtn" class="btn">
                    <i class="fas fa-sign-in-alt"></i>
                    تسجيل الدخول
                </button>
                <button id="logoutBtn" class="btn btn-secondary" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i>
                    تسجيل الخروج
                </button>
            </div>
        </div>
    </header>

    <div class="container">

        <div id="successAlert" class="alert alert-success"></div>
        <div id="errorAlert" class="alert alert-error"></div>


        <div id="placeStatusBar" style="display: none;">
            <div id="placeStatusMessage"></div>
            <div id="placeStatusButtons">
                <button class="status-btn" data-status="مفتوح">مفتوح</button>
                <button class="status-btn" data-status="مغلق">مغلق</button>
                <button class="status-btn" data-status="مغلق للصلاة">مغلق للصلاة</button>
            </div>
        </div>


        <div id="subscriptionStatusBar" style="display: none;">
            <div class="subscription-content">
                <div>
                    <h4 id="subscriptionTitle"></h4>
                    <p id="subscriptionDetails"></p>
                </div>
                <div id="subscriptionCountdown"></div>
            </div>
        </div>

   
        <div class="tabs">
            <button class="tab active" id="tab-places" onclick="showTab('places')">
                <i class="fas fa-store"></i>
                بيانات المكان
            </button>
            <button class="tab" id="tab-ads" onclick="showTab('ads')" style="display: none;">
                <i class="fas fa-bullhorn"></i>
                الإعلانات
            </button>
            <button class="tab" id="tab-packages" onclick="showTab('packages')">
                <i class="fas fa-box"></i>
                الباقات
            </button>
        </div>

        <div id="places-tab" class="tab-content">
            <h2>بيانات المكان أو الخدمة</h2>
            <form id="placeForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="placeName">اسم المكان أو الخدمة *</label>
                        <input type="text" name="placeName" id="placeName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="password">كلمة المرور *</label>
                        <input type="password" name="password" id="password" class="form-control" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="activityType">نوع النشاط / الفئة</label>
                        <select name="activityType" id="activityType" class="form-control">
                            <option value="">اختر نوع النشاط</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="city">المدينة</label>
                        <select name="city" id="city" class="form-control">
                            <option value="">اختر المدينة</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="area">المنطقة</label>
                        <select name="area" id="area" class="form-control">
                            <option value="">اختر المنطقة</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="location">الموقع أو المول</label>
                        <select name="location" id="location" class="form-control">
                            <option value="">اختر الموقع</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="detailedAddress">العنوان التفصيلي</label>
                    <input type="text" name="detailedAddress" id="detailedAddress" class="form-control">
                </div>

                <div class="form-group">
                    <label for="mapLink">رابط الموقع على الخريطة</label>
                    <input type="url" name="mapLink" id="mapLink" class="form-control" placeholder="https://maps.google.com/...">
                    <button type="button" id="autoLocateBtn" class="btn auto-locate-btn">
                        <i class="fas fa-location-arrow"></i>
                        استخدم موقعي الحالي
                    </button>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="phone">رقم التواصل</label>
                        <input type="tel" name="phone" id="phone" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="whatsappLink">رابط واتساب</label>
                        <input type="url" name="whatsappLink" id="whatsappLink" class="form-control" placeholder="https://wa.me/...">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="email">البريد الإلكتروني</label>
                        <input type="email" name="email" id="email" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="website">الموقع الإلكتروني</label>
                        <input type="url" name="website" id="website" class="form-control" placeholder="https://...">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="workingHours">ساعات العمل</label>
                        <input type="text" name="workingHours" id="workingHours" class="form-control" placeholder="9:00 ص - 10:00 م">
                    </div>
                    <div class="form-group">
                        <label for="delivery">خدمات التوصيل</label>
                        <select name="delivery" id="delivery" class="form-control">
                            <option value="">اختر</option>
                            <option value="متوفر">متوفر</option>
                            <option value="غير متوفر">غير متوفر</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="description">وصف مختصر</label>
                    <textarea name="description" id="description" class="form-control" rows="3" placeholder="اكتب وصفاً مختصراً عن المكان أو الخدمة..."></textarea>
                </div>

                <div class="form-group">
                    <label for="placeImage">صورة شعار أو صورة المكان</label>
                    <input type="file" name="placeImage" id="placeImage" class="form-control" accept="image/*" onchange="previewImage(this, 'placeImagePreview')">
                    <div id="placeImagePreview" class="preview"></div>
                </div>

                <div class="text-center">
                    <button type="submit" id="savePlaceBtn" class="btn btn-success">
                        <i class="fas fa-save"></i>
                        حفظ بيانات المكان
                    </button>
                    <button type="button" id="goPackagesBtn" class="btn" style="margin-right: 10px;">
                        <i class="fas fa-box"></i>
                        انتقل إلى الباقات
                    </button>
                </div>
            </form>
        </div>

   
        <div id="ads-tab" class="tab-content" style="display: none;">
            <h2>إدارة الإعلانات</h2>
            
            <div id="adQuotaSummary"></div>
            <div id="adQuotaNotice"></div>

            <form id="adForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="adPlaceId">المكان</label>
                        <select name="placeId" id="adPlaceId" class="form-control" required>
                            <option value="">اختر المكان</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="adType">نوع الإعلان</label>
                        <select name="adType" id="adType" class="form-control" required>
                            <option value="">اختر نوع الإعلان</option>
                            <option value="عرض خاص">عرض خاص</option>
                            <option value="منتج جديد">منتج جديد</option>
                            <option value="خدمة">خدمة</option>
                            <option value="حدث">حدث</option>
                            <option value="أخرى">أخرى</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="adTitle">عنوان الإعلان *</label>
                    <input type="text" name="adTitle" id="adTitle" class="form-control" required>
                </div>

                <div class="form-group">
                    <label for="coupon">كوبون خصم (اختياري)</label>
                    <input type="text" name="coupon" id="coupon" class="form-control" placeholder="كود الخصم">
                </div>

                <div class="form-group">
                    <label for="adDescription">وصف الإعلان</label>
                    <textarea name="adDescription" id="adDescription" class="form-control" rows="4" placeholder="اكتب وصفاً تفصيلياً للإعلان..."></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="startDate">تاريخ البداية</label>
                        <input type="date" name="startDate" id="startDate" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="endDate">تاريخ النهاية</label>
                        <input type="date" name="endDate" id="endDate" class="form-control" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="adActiveStatus">حالة الإعلان</label>
                    <select name="adActiveStatus" id="adActiveStatus" class="form-control">
                        <option value="">اختر الحالة</option>
                        <option value="نشط">نشط</option>
                        <option value="غير نشط">غير نشط</option>
                        <option value="مؤجل">مؤجل</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="adImages">صور الإعلان (حتى 8 صور)</label>
                    <input type="file" name="adImages" id="adImages" class="form-control" accept="image/*" multiple onchange="previewMultipleImages(this, 'adImagesPreview')">
                    <div id="adImagesPreview" class="preview"></div>
                </div>

                <div class="form-group">
                    <label for="adVideo">فيديو الإعلان (اختياري)</label>
                    <input type="file" name="adVideo" id="adVideo" class="form-control" accept="video/*" onchange="previewVideo(this, 'adVideoPreview')">
                    <div id="adVideoPreview" class="preview"></div>
                </div>

                <div class="text-center">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i>
                        حفظ الإعلان
                    </button>
                </div>
            </form>

            <hr class="mt-3 mb-3">

            <h3>إعلاناتك</h3>
            <div id="adsListContainer">
                <p>لا توجد إعلانات حالياً.</p>
            </div>
        </div>

   
        <div id="packages-tab" class="tab-content" style="display: none;">
            <h2>الباقات المتاحة</h2>
            <p>اختر الباقة المناسبة لاحتياجاتك:</p>
            
            <div id="packagesGrid" class="packages-grid">
             
            </div>
        </div>
    </div>


    <div id="loginModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">تسجيل الدخول</h3>
                <button id="loginCancel" class="modal-close">&times;</button>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="phoneOrId">رقم الهاتف أو ID المكان</label>
                    <input type="text" name="phoneOrId" id="phoneOrId" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">كلمة المرور</label>
                    <input type="password" name="password" id="loginPassword" class="form-control" required>
                </div>
                <div class="text-center">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-sign-in-alt"></i>
                        دخول
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="script.js"></script>
</body>
</html>
 -->





















































<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة التحكم - خدمتك</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #f7f7fb;
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --primary: #3b82f6;
      --primary-600: #2563eb;
      --success: #10b981;
      --warning-bg: #fff3cd;
      --warning-text: #856404;
      --danger: #ef4444;
      --border: #e5e7eb;
      --shadow: 0 8px 24px rgba(0,0,0,0.06);
    }
    body { margin:0; font-family: 'Tajawal', sans-serif; background: var(--bg); color: var(--text); }
    .container { max-width: 1100px; margin: 0 auto; padding: 16px; }
    header { display:flex; align-items:center; justify-content:space-between; padding:12px 0; }
    header h1 { font-size:20px; margin:0; }
    .toolbar { display:flex; gap:10px; align-items:center; }
    .btn { background: var(--primary); color: #fff; border:0; padding:10px 14px; border-radius:8px; cursor:pointer; }
    .btn:hover { background: var(--primary-600); }
    .btn-secondary { background:#e5e7eb; color:#111; }
    .btn-secondary:hover { background:#d1d5db; }
    .alert { display:none; padding:12px; border-radius:8px; margin:10px 0; }
    .alert-success { background:#ecfdf5; color:#065f46; }
    .alert-error { background:#fef2f2; color:#991b1b; }
    #loading { display:none; margin:10px 0; color: var(--muted); }

    /* Tabs */
    .tabs { display:flex; gap:8px; margin:10px 0 14px; flex-wrap: wrap; }
    .tab { padding:10px 14px; border-radius:8px; background:#eef2ff; color:#1e3a8a; cursor:pointer; }
    .tab.active { background:#1e3a8a; color:#fff; }
    .tab-content { display:none; background: var(--card); border:1px solid var(--border); border-radius:12px; box-shadow: var(--shadow); padding:16px; }

    /* Forms */
    .grid { display:grid; grid-template-columns: repeat(12, 1fr); gap:12px; }
    .col-12 { grid-column: span 12; }
    .col-6 { grid-column: span 6; }
    .col-4 { grid-column: span 4; }
    .field { display:flex; flex-direction:column; gap:6px; }
    label { font-size: 14px; color: var(--muted); }
    input, select, textarea { padding:10px; border:1px solid var(--border); border-radius:8px; background:#fff; font-family:inherit; }
    textarea { min-height: 100px; }
    .actions { display:flex; gap:10px; justify-content:flex-end; margin-top:10px; }

    /* Status bars */
    #placeStatusBar { display:none; background:#fff; border:1px solid var(--border); border-radius:10px; padding:12px; box-shadow: var(--shadow); margin-bottom:10px; }
    #placeStatusButtons { display:flex; flex-wrap: wrap; gap:8px; }
    .status-btn { border:1px solid var(--border); border-radius:999px; padding:8px 12px; background:#fafafa; cursor:pointer; }
    .status-btn.active { background: var(--success); color:#fff; border-color: transparent; }
    #placeStatusMessage { color: var(--muted); margin-top:8px; }

    /* New subscription top bar */
    #subscriptionStatusBar { display:none; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; padding:14px; border-radius:10px; box-shadow: var(--shadow); margin-bottom:14px; }
    #subscriptionStatusBar h4 { margin:0 0 4px; font-size:16px; font-weight:700; }
    #subscriptionStatusBar p { margin:0; font-size:14px; opacity:0.95; }
    #subscriptionCountdown { background: rgba(255,255,255,0.18); padding:8px 12px; border-radius:8px; font-weight:700; min-width:140px; text-align:center; }

    /* Packages grid */
    #packagesGrid { display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:12px; }
    .pkg-card { background:#fff; border:1px solid var(--border); border-radius:12px; padding:14px; box-shadow: var(--shadow); }
    .pkg-card h3 { margin:0 0 8px; font-size:18px; }
    .pkg-card p { margin:6px 0; color: var(--muted); font-size:14px; }
    .pkg-card .choose-pkg { margin-top:8px; }

    /* Ads cards */
    .ad-card { background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px; box-shadow: var(--shadow); margin-bottom:10px; }
    .ad-card h4 { margin:0 0 6px; }
    .ad-card .meta { color: var(--muted); font-size: 13px; margin-bottom: 8px; }
    .ad-images { display:flex; gap:8px; flex-wrap: wrap; }
    .ad-images img { width: 100px; height: 72px; object-fit: cover; border-radius:8px; border:1px solid var(--border); }
    .img-placeholder-file { background:#f3f4f6; border:1px dashed var(--border); color: var(--muted); border-radius:8px; padding:10px; font-size:12px; min-width:100px; text-align:center; }

    /* Previews */
    #placeImagePreview img { width: 120px; height: 120px; object-fit: cover; border-radius:10px; border:1px solid var(--border); }
    .preview-image { position: relative; }
    .preview-image img { width: 100px; height: 72px; object-fit: cover; border-radius:8px; border:1px solid var(--border); }
    .remove-image { position:absolute; top:-8px; left:-8px; background:#111827; color:#fff; width:24px; height:24px; border-radius:50%; line-height:24px; border:0; cursor:pointer; }

    /* Modal */
    .modal { position:fixed; inset:0; background: rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; z-index: 9999; }
    .modal .box { background:#fff; border-radius:12px; padding:16px; width:min(92%, 480px); box-shadow: var(--shadow); }
    .modal .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    .close { background:#e5e7eb; border:0; border-radius:8px; padding:6px 10px; cursor:pointer; }

    /* Theme toggle */
    #themeToggleBtn { background:#111827; border:0; color:#fff; padding:8px 10px; border-radius:8px; cursor:pointer; }

    /* Dark mode */
    body.dark { --bg:#0f172a; --card:#0b1220; --text:#e5e7eb; --muted:#94a3b8; --border:#1f2937; --shadow: 0 8px 24px rgba(0,0,0,0.5); }
    body.dark .tab { background:#0b1220; color:#93c5fd; border:1px solid var(--border); }
    body.dark .tab.active { background:#1d4ed8; color:#fff; }
    body.dark input, body.dark select, body.dark textarea { background:#0b1220; color:#e5e7eb; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>لوحة التحكم</h1>
      <div class="toolbar">
        <span id="loggedInUser" style="display:none"></span>
        <button id="loginBtn" class="btn-secondary">تسجيل الدخول</button>
        <button id="logoutBtn" class="btn-secondary" style="display:none">تسجيل الخروج</button>
        <button id="themeToggleBtn"><i id="themeIcon" class="fas fa-moon"></i> <span id="themeLabel">الوضع الليلي</span></button>
      </div>
    </header>

    <div id="successAlert" class="alert alert-success"></div>
    <div id="errorAlert" class="alert alert-error"></div>
    <div id="loading">جاري المعالجة...</div>

    <!-- شريط حالة المكان -->
    <div id="placeStatusBar">
      <div style="display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap: wrap;">
        <div id="placeStatusButtons">
          <button class="status-btn" data-status="مفتوح">مفتوح</button>
          <button class="status-btn" data-status="مغلق">مغلق</button>
          <button class="status-btn" data-status="مغلق للصلاة">مغلق للصلاة</button>
        </div>
        <div id="placeStatusMessage"></div>
      </div>
    </div>

    <!-- شريط ملخص الاشتراك الثابت -->
    <div id="subscriptionStatusBar">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap: wrap;">
        <div>
          <h4 id="subscriptionTitle"></h4>
          <p id="subscriptionDetails"></p>
        </div>
        <div id="subscriptionCountdown"></div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <div id="tab-places" class="tab active" onclick="showTab('places')">بيانات المكان</div>
      <div id="tab-ads" class="tab" onclick="showTab('ads')" style="display:none">الإعلانات</div>
      <div id="tab-packages" class="tab" onclick="showTab('packages')">الباقات</div>
    </div>

    <!-- Places tab -->
    <div id="places-tab" class="tab-content" style="display:block">
      <form id="placeForm">
        <div class="grid">
          <div class="col-6">
            <div class="field">
              <label>اسم المكان</label>
              <input name="placeName" type="text" placeholder="مثال: مطعم لذيذ" />
            </div>
          </div>
          <div class="col-6">
            <div class="field">
              <label>كلمة المرور</label>
              <input name="password" type="password" placeholder="••••••••" />
            </div>
          </div>

          <div class="col-4">
            <div class="field">
              <label>نوع النشاط</label>
              <select name="activityType">
                <option value="">اختر نوع النشاط</option>
              </select>
            </div>
          </div>
          <div class="col-4">
            <div class="field">
              <label>المدينة</label>
              <select name="city">
                <option value="">اختر المدينة</option>
              </select>
            </div>
          </div>
          <div class="col-4">
            <div class="field">
              <label>المنطقة</label>
              <select name="area">
                <option value="">اختر المنطقة</option>
              </select>
            </div>
          </div>

          <div class="col-6">
            <div class="field">
              <label>الموقع أو المول</label>
              <select name="location">
                <option value="">اختر الموقع</option>
              </select>
            </div>
          </div>
          <div class="col-6">
            <div class="field">
              <label>العنوان التفصيلي</label>
              <input name="detailedAddress" type="text" placeholder="وصف مختصر للموقع" />
            </div>
          </div>

          <div class="col-8">
            <div class="field">
              <label>رابط الموقع على الخريطة</label>
              <input name="mapLink" type="text" placeholder="رابط خرائط جوجل" />
            </div>
          </div>
          <div class="col-4" style="display:flex; align-items:flex-end">
            <button id="autoLocateBtn" class="btn-secondary" type="button">استخدم موقعي</button>
          </div>

          <div class="col-4">
            <div class="field">
              <label>رقم التواصل</label>
              <input name="phone" type="text" placeholder="05xxxxxxxx" />
            </div>
          </div>
          <div class="col-4">
            <div class="field">
              <label>رابط واتساب</label>
              <input name="whatsappLink" type="text" placeholder="https://wa.me/..." />
            </div>
          </div>
          <div class="col-4">
            <div class="field">
              <label>البريد الإلكتروني</label>
              <input name="email" type="email" placeholder="you@example.com" />
            </div>
          </div>

          <div class="col-6">
            <div class="field">
              <label>الموقع الإلكتروني</label>
              <input name="website" type="text" placeholder="https://..." />
            </div>
          </div>
          <div class="col-6">
            <div class="field">
              <label>ساعات العمل</label>
              <input name="workingHours" type="text" placeholder="مثال: 12م - 12ص" />
            </div>
          </div>

          <div class="col-6">
            <div class="field">
              <label>خدمات التوصيل</label>
              <input name="delivery" type="text" placeholder="متاح | غير متاح | تفاصيل" />
            </div>
          </div>
          <div class="col-6">
            <div class="field">
              <label>وصف مختصر</label>
              <textarea name="description" placeholder="نبذة قصيرة عن المكان"></textarea>
            </div>
          </div>

          <div class="col-6">
            <div class="field">
              <label>صورة الشعار/المكان</label>
              <input type="file" accept="image/*" onchange="previewImage(this, 'placeImagePreview')" />
              <div id="placeImagePreview" style="margin-top:6px;"></div>
            </div>
          </div>

          <div class="col-12 actions">
            <button id="savePlaceBtn" class="btn" type="submit"><i class="fas fa-save"></i> حفظ</button>
            <button id="goPackagesBtn" class="btn-secondary" type="button">الانتقال إلى الباقات</button>
          </div>
        </div>
      </form>
    </div>

    <!-- Ads tab -->
    <div id="ads-tab" class="tab-content">
      <form id="adForm">
        <div class="grid">
          <div class="col-4">
            <div class="field">
              <label>اختر المكان</label>
              <select name="placeId"><option value="">اختر المكان</option></select>
            </div>
          </div>
          <div class="col-4">
            <div class="field">
              <label>نوع الإعلان</label>
              <select name="adType">
                <option value="عرض">عرض</option>
                <option value="إعلان عام">إعلان عام</option>
              </select>
            </div>
          </div>
          <div class="col-4">
            <div class="field">
              <label>العنوان</label>
              <input name="adTitle" type="text" placeholder="عنوان جذاب" />
            </div>
          </div>

          <div class="col-6">
            <div class="field">
              <label>كوبون خصم (اختياري)</label>
              <input name="coupon" type="text" />
            </div>
          </div>
          <div class="col-6">
            <div class="field">
              <label>الوصف</label>
              <input name="adDescription" type="text" placeholder="وصف مختصر للإعلان" />
            </div>
          </div>

          <div class="col-6">
            <div class="field">
              <label>تاريخ البداية</label>
              <input name="startDate" type="date" />
            </div>
          </div>
          <div class="col-6">
            <div class="field">
              <label>تاريخ النهاية</label>
              <input name="endDate" type="date" />
            </div>
          </div>

          <div class="col-8">
            <div class="field">
              <label>صور الإعلان (حتى 8)</label>
              <input type="file" accept="image/*" multiple onchange="previewMultipleImages(this, 'adImagesPreview')" />
              <div id="adImagesPreview" style="margin-top:6px; display:flex; gap:8px; flex-wrap:wrap;"></div>
            </div>
          </div>
          <div class="col-4">
            <div class="field">
              <label>فيديو (اختياري)</label>
              <input type="file" accept="video/*" onchange="previewVideo(this, 'adVideoPreview')" />
              <div id="adVideoPreview" style="margin-top:6px;"></div>
            </div>
          </div>

          <div class="col-6">
            <div class="field">
              <label>حالة الإعلان</label>
              <select name="adActiveStatus">
                <option value="نشط">نشط</option>
                <option value="مغلق">مغلق</option>
              </select>
            </div>
          </div>
          <div class="col-6">
            <div class="field">
              <label>حالة داخلية (اختياري)</label>
              <select name="adStatus">
                <option value="">—</option>
                <option value="قيد المراجعة">قيد المراجعة</option>
              </select>
            </div>
          </div>

          <div class="col-12 actions">
            <button class="btn" type="submit">حفظ الإعلان</button>
          </div>
        </div>
      </form>

      <div id="adQuotaSummary" style="margin-top:8px;"></div>
      <div id="adQuotaNotice" style="display:none;"></div>

      <div id="adsListContainer" style="margin-top:12px;"></div>
    </div>

    <!-- Packages tab -->
    <div id="packages-tab" class="tab-content">
      <!-- ملاحظة: تمت إزالة بطاقة "باقتك الحالية" من هذا القسم لأن الشريط العلوي ثابت -->
      <div id="packagesGrid"></div>
    </div>
  </div>

  <!-- Login modal -->
  <div id="loginModal" class="modal">
    <div class="box">
      <div class="header">
        <strong>تسجيل الدخول</strong>
        <button id="loginCancel" class="close">إغلاق</button>
      </div>
      <form id="loginForm">
        <div class="field">
          <label>رقم الجوال أو ID المكان</label>
          <input name="phoneOrId" type="text" />
        </div>
        <div class="field">
          <label>كلمة المرور</label>
          <input name="password" type="password" />
        </div>
        <div class="actions">
          <button class="btn" type="submit">دخول</button>
        </div>
      </form>
    </div>
  </div>

  <!-- FontAwesome (اختياري للأيقونات) -->
  <script src="https://kit.fontawesome.com/5b3d1e7c6e.js" crossorigin="anonymous"></script>

  <script>
    /* كل جافاسكربت (script.js) مدمج هنا كما طلبت */

    const API_URL = 'https://script.google.com/macros/s/AKfycbwB0VE5COC0e6NQNKrxQeNRu2Mtt_QuMbVoBrH7tE6Da3X3BP6UxK926bt9fDO0WPU5/exec';

    let currentTab = 'places';
    let uploadedImages = [];
    let uploadedVideos = [];
    let editingAdId = null;
    const recentUploads = {};
    const THEME_KEY = 'khedmatak_theme';

    function applyTheme(theme) {
      if (theme === 'dark') {
        document.body.classList.add('dark');
        const icon = document.getElementById('themeIcon');
        const lbl = document.getElementById('themeLabel');
        if (icon) icon.className = 'fas fa-sun';
        if (lbl) lbl.textContent = 'الوضع النهاري';
      } else {
        document.body.classList.remove('dark');
        const icon = document.getElementById('themeIcon');
        const lbl = document.getElementById('themeLabel');
        if (icon) icon.className = 'fas fa-moon';
        if (lbl) lbl.textContent = 'الوضع الليلي';
      }
      try { localStorage.setItem(THEME_KEY, theme || 'light'); } catch {}
    }
    function toggleTheme() {
      const cur = (localStorage.getItem(THEME_KEY) === 'dark') ? 'dark' : 'light';
      applyTheme(cur === 'dark' ? 'light' : 'dark');
    }
    function initTheme() {
      try {
        const saved = localStorage.getItem(THEME_KEY);
        if (saved) applyTheme(saved);
        else {
          const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
          applyTheme(prefersDark ? 'dark' : 'light');
        }
      } catch { applyTheme('light'); }
    }

    async function apiFetch(url, opts = {}) {
      try {
        const res = await fetch(url, opts);
        const text = await res.text();
        let data;
        try { data = JSON.parse(text); } catch { data = text; }
        return { ok: res.ok, status: res.status, data, raw: text };
      } catch (err) {
        return { ok: false, status: 0, error: err?.message || String(err) };
      }
    }
    async function apiPost(payload) {
      try {
        if (payload instanceof FormData) {
          return await apiFetch(API_URL, { method: 'POST', body: payload });
        }
        if (payload && typeof payload === 'object') {
          const form = new FormData();
          for (const k of Object.keys(payload)) {
            const v = payload[k];
            if (v !== null && typeof v === 'object') form.append(k, JSON.stringify(v));
            else form.append(k, v === undefined ? '' : v);
          }
          return await apiFetch(API_URL, { method: 'POST', body: form });
        }
        return await apiFetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain' }, body: String(payload) });
      } catch (err) {
        return { ok: false, status: 0, error: err?.message || String(err) };
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      initializeApp();
      initTheme();
      const themeBtn = document.getElementById('themeToggleBtn');
      if (themeBtn) themeBtn.addEventListener('click', toggleTheme);

      setupEventListeners();
      loadLookupsAndPopulate();
      loadPlacesForAds();
      setupAuthUI();
      initMapAutoLocate();
      initMapLinkAutoFill();

      if (typeof updateAdsTabVisibility === 'function') updateAdsTabVisibility();

      const stored = getLoggedPlace();
      if (stored && stored.id) showPlaceStatusBar(stored);
      else hidePlaceStatusBar();
      initPlaceStatusButtons();
    });

    function initializeApp() {
      const today = new Date().toISOString().split('T')[0];
      const startInput = document.querySelector('input[name="startDate"]');
      const endInput = document.querySelector('input[name="endDate"]');
      if (startInput) startInput.value = today;
      const nextWeek = new Date(); nextWeek.setDate(nextWeek.getDate() + 7);
      if (endInput) endInput.value = nextWeek.toISOString().split('T')[0];
    }

    function setupEventListeners() {
      const placeForm = document.getElementById('placeForm');
      const adForm = document.getElementById('adForm');
      const citySelect = document.querySelector('select[name="city"]');
      const goPackagesBtn = document.getElementById('goPackagesBtn');

      if (placeForm) placeForm.addEventListener('submit', handlePlaceSubmit);
      if (adForm) adForm.addEventListener('submit', handleAdSubmit);
      if (citySelect) citySelect.addEventListener('change', updateAreas);
      if (goPackagesBtn) goPackagesBtn.addEventListener('click', () => {
        const logged = getLoggedPlace();
        if (!logged || !logged.id) { showError('احفظ بيانات المكان أولاً للانتقال إلى الباقات'); return; }
        showTab('packages');
      });
    }

    async function loadLookupsAndPopulate() {
      try {
        const resp = await apiFetch(`${API_URL}?action=getLookups`);
        if (!resp.ok) { console.warn('getLookups failed', resp); return; }
        const json = resp.data;
        const data = (json && json.success && json.data) ? json.data : json;
        if (!data) return;

        window.lastLookups = data;

        const actSelect = document.querySelector('select[name="activityType"]');
        if (actSelect) {
          actSelect.innerHTML = '<option value="">اختر نوع النشاط</option>';
          (data.activities || []).forEach(a => {
            const opt = document.createElement('option'); opt.value = a.id; opt.textContent = a.name; actSelect.appendChild(opt);
          });
        }

        const citySelect = document.querySelector('select[name="city"]');
        if (citySelect) {
          citySelect.innerHTML = '<option value="">اختر المدينة</option>';
          (data.cities || []).forEach(c => {
            const opt = document.createElement('option'); opt.value = c.id; opt.textContent = c.name; citySelect.appendChild(opt);
          });
        }

        const cityAreaMap = {};
        (data.areas || []).forEach(a => {
          const cid = a.raw && (a.raw['ID المدينة'] || a.raw['cityId']) ? String(a.raw['ID المدينة'] || a.raw['cityId']) : '';
          if (!cityAreaMap[cid]) cityAreaMap[cid] = [];
          cityAreaMap[cid].push({ id: a.id, name: a.name });
        });
        window.cityAreaMap = cityAreaMap;

        const siteSelects = document.querySelectorAll('select[name="location"]');
        siteSelects.forEach(s => {
          s.innerHTML = '<option value="">اختر الموقع</option>';
          (data.sites || []).forEach(site => {
            const opt = document.createElement('option'); opt.value = site.id; opt.textContent = site.name; s.appendChild(opt);
          });
        });

        // packages grid
        const pkgGrid = document.getElementById('packagesGrid');
        if (pkgGrid) {
          pkgGrid.innerHTML = '';
          const logged = getLoggedPlace();
          const currentPkgId = logged && logged.raw ? String(logged.raw['الباقة'] || logged.package || logged.raw['packageId'] || '') : '';
          const currentPkgStatus = logged && logged.raw ? String(logged.raw['حالة الباقة'] || logged.packageStatus || '').trim() : '';

          (data.packages || []).forEach(p => {
            const div = document.createElement('div'); div.className = 'pkg-card';
            const h = document.createElement('h3'); h.textContent = p.name;

            const dur = Number(p.duration || (p.raw && (p.raw['مدة الباقة باليوم'] || p.raw['مدة'])) || 0) || 0;
            const price = Number(p.price || (p.raw && (p.raw['سعر الباقة'] || p.raw['السعر'])) || 0) || 0;
            const allowed = Number(p.allowedAds || (p.raw && (p.raw['عدد الاعلانات'] || p.raw['عدد_الاعلانات'])) || 0) || 0;

            const d = document.createElement('p'); d.textContent = `المدة: ${dur} يوم · السعر: ${price} · الإعلانات: ${allowed}`;
            const desc = document.createElement('p');
            desc.textContent = p.raw && (p.raw['وصف الباقة'] || p.raw['description']) ? (p.raw['وصف الباقة'] || p.raw['description']) : '';

            const btn = document.createElement('button'); btn.className = 'btn choose-pkg';

            const isCurrent = currentPkgId && String(p.id) === String(currentPkgId);
            if (isCurrent) {
              div.style.border = '2px solid #10b981';
              div.style.boxShadow = '0 6px 18px rgba(16,185,129,0.15)';
              const badge = document.createElement('div');
              badge.textContent = 'باقتك الحالية';
              badge.style.cssText = 'display:inline-block;background:#10b981;color:#fff;padding:4px 8px;border-radius:999px;margin-bottom:8px;font-size:12px;font-weight:700';
              div.insertBefore(badge, h);
            }

            if (isCurrent && currentPkgStatus === 'نشطة') {
              btn.textContent = 'هذه باقتك'; btn.disabled = true;
            } else if (isCurrent && currentPkgStatus === 'قيد الدفع') {
              btn.textContent = 'قيد الدفع'; btn.disabled = true;
            } else if (isCurrent && currentPkgStatus === 'منتهية') {
              btn.textContent = 'إعادة التفعيل';
            } else {
              btn.textContent = (price === 0) ? 'تفعيل فوري' : 'اختر الباقة';
            }

            btn.onclick = async () => {
              const logged = getLoggedPlace();
              if (!logged || !logged.id) { showError('احفظ بيانات المكان أولاً'); return; }
              if (price === 0) {
                const block = await checkIfTrialIsUsed(logged.id);
                if (block) { showError('الباقة التجريبية غير متاحة مرة أخرى بعد انتهاء اشتراك سابق.'); return; }
              }
              await choosePackageAPI(p.id, { price });
            };

            div.appendChild(h);
            div.appendChild(d);
            if (desc.textContent) div.appendChild(desc);
            div.appendChild(btn);
            pkgGrid.appendChild(div);
          });
        }

        window.availablePaymentMethods = (data.payments || data.paymentsMethods || []).map(pm => ({
          id: pm.id || pm.raw && pm.raw['معرف الدفع'],
          name: pm.name || pm.raw && (pm.raw['طرق الدفع'] || pm.raw['طريقة الدفع']),
          raw: pm.raw || pm
        }));

        const stored = getLoggedPlace();
        if (stored && stored.raw) {
          await tryPrefillPlaceForm(stored);
          if (stored.id) {
            if (typeof checkAdQuotaAndToggle === 'function') checkAdQuotaAndToggle(stored.id);
            if (typeof loadAdsForPlace === 'function') loadAdsForPlace(stored.id);
          }
        }

        if (typeof updateAdsTabVisibility === 'function') updateAdsTabVisibility();

        // تحديث الشريط الثابت (بدلاً من بطاقات متفرقة)
        await refreshSubscriptionBar();
      } catch (err) {
        console.error('loadLookupsAndPopulate error', err);
      }
    }

    function updateAreas() {
      const citySelect = document.querySelector('select[name="city"]');
      const areaSelect = document.querySelector('select[name="area"]');
      if (!citySelect || !areaSelect) return;
      areaSelect.innerHTML = '<option value="">اختر المنطقة</option>';
      const selected = citySelect.value;
      if (selected && window.cityAreaMap && window.cityAreaMap[selected]) {
        window.cityAreaMap[selected].forEach(a => {
          const opt = document.createElement('option'); opt.value = a.id; opt.textContent = a.name; areaSelect.appendChild(opt);
        });
      }
    }

    function showTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      const target = document.getElementById(tabName + '-tab');
      if (target) target.style.display = 'block';
      const tabEl = document.getElementById('tab-' + tabName);
      if (tabEl) tabEl.classList.add('active');
      currentTab = tabName;
    }

    function previewImage(input, previewId) {
      const preview = document.getElementById(previewId);
      if (!preview) return;
      preview.innerHTML = '';
      if (input.files && input.files[0]) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = e => {
          const img = document.createElement('img');
          img.src = e.target.result;
          preview.appendChild(img);
          uploadedImages = [file];
        };
        reader.readAsDataURL(file);
      }
    }
    function previewMultipleImages(input, previewId) {
      const preview = document.getElementById(previewId);
      if (!preview) return;
      preview.innerHTML = '';
      uploadedImages = [];
      if (!input.files) return;
      const files = Array.from(input.files).slice(0, 8);
      if (input.files.length > 8) showError('يمكن تحميل حتى 8 صور كحد أقصى. سيتم أخذ أول 8 صور.');
      files.forEach(file => {
        const reader = new FileReader();
        reader.onload = e => {
          const div = document.createElement('div'); div.className = 'preview-image';
          const img = document.createElement('img'); img.src = e.target.result;
          const removeBtn = document.createElement('button'); removeBtn.className = 'remove-image'; removeBtn.innerHTML = '×';
          removeBtn.onclick = () => { div.remove(); uploadedImages = uploadedImages.filter(f => f !== file); };
          div.appendChild(img); div.appendChild(removeBtn); preview.appendChild(div);
          uploadedImages.push(file);
        };
        reader.readAsDataURL(file);
      });
    }
    function previewVideo(input, previewId) {
      const preview = document.getElementById(previewId);
      if (!preview) return;
      preview.innerHTML = '';
      uploadedVideos = [];
      if (input.files && input.files[0]) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = e => {
          const video = document.createElement('video');
          video.src = e.target.result; video.controls = true; video.style.width = '100%';
          preview.appendChild(video);
          uploadedVideos = [file];
        };
        reader.readAsDataURL(file);
      }
    }

    async function readFileAsBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => { const result = reader.result; const base64 = String(result).split(',')[1] || ''; resolve(base64); };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
    async function uploadToGoogleDrive(file, folder, placeId = null) {
      if (!API_URL || !API_URL.startsWith('http')) {
        return `https://drive.google.com/file/d/${Math.random().toString(36).substr(2, 9)}/view`;
      }
      const base64 = await readFileAsBase64(file);
      const form = new FormData();
      form.append('action', 'uploadFile');
      form.append('folder', folder);
      form.append('fileName', file.name);
      form.append('mimeType', file.type || 'application/octet-stream');
      form.append('fileData', base64);
      if (placeId) form.append('placeId', placeId);
      const resp = await apiPost(form);
      if (!resp.ok) throw new Error('فشل رفع الملف');
      const data = resp.data;
      const up = (data && data.data) ? data.data : data;
      const fileUrl = (up && (up.fileUrl || up.url)) || (resp && resp.fileUrl) || '';
      if (fileUrl) recentUploads[file.name] = { url: fileUrl, name: file.name };
      if (!fileUrl) throw new Error('تعذر استخراج رابط الملف من استجابة الخادم');
      return fileUrl;
    }

    async function handlePlaceSubmit(ev) {
      ev.preventDefault();
      showLoading(true);
      const submitBtn = document.getElementById('savePlaceBtn');
      const oldHtml = submitBtn ? submitBtn.innerHTML : '';
      if (submitBtn) { submitBtn.disabled = true; submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الحفظ...'; }
      try {
        const form = ev.target;
        const formData = new FormData(form);
        const placeData = {
          placeName: formData.get('placeName'),
          password: formData.get('password'),
          activityType: formData.get('activityType'),
          city: formData.get('city'),
          area: formData.get('area'),
          location: formData.get('location'),
          detailedAddress: formData.get('detailedAddress'),
          mapLink: formData.get('mapLink'),
          phone: formData.get('phone'),
          whatsappLink: formData.get('whatsappLink'),
          email: formData.get('email'),
          website: formData.get('website'),
          workingHours: formData.get('workingHours'),
          delivery: formData.get('delivery'),
          description: formData.get('description'),
          image: uploadedImages[0] || null
        };

        if (!validateFiles()) { showLoading(false); return; }

        const logged = getLoggedPlace();
        let imageUrl = '';
        if (placeData.image) {
          const placeIdForUpload = (logged && logged.id) ? logged.id : null;
          imageUrl = await uploadToGoogleDrive(placeData.image, 'places', placeIdForUpload);
        }

        const payload = { action: (logged && logged.id) ? 'updatePlace' : 'registerPlace' };
        if (logged && logged.id) payload.placeId = logged.id;
        const setIf = (k, v) => { if (v !== undefined && v !== null && String(v).trim() !== '') payload[k] = v; };

        setIf('name', placeData.placeName);
        setIf('password', placeData.password);
        setIf('activityId', placeData.activityType);
        setIf('activityType', placeData.activityType);
        setIf('city', placeData.city);
        setIf('area', placeData.area);
        setIf('mall', placeData.location);
        setIf('address', placeData.detailedAddress);
        setIf('mapLink', placeData.mapLink);
        setIf('phone', placeData.phone);
        setIf('whatsappLink', placeData.whatsappLink);
        setIf('email', placeData.email);
        setIf('website', placeData.website);
        setIf('hours', placeData.workingHours);
        setIf('delivery', placeData.delivery);
        setIf('description', placeData.description);
        setIf('logoUrl', imageUrl);

        const resp = await apiPost(payload);
        if (!resp.ok) throw new Error('فشل في التواصل مع الخادم عند حفظ المكان');
        const data = resp.data;
        if (!data || data.success === false) {
          const err = data && data.error ? data.error : JSON.stringify(data);
          throw new Error(err);
        }

        const returned = (data && data.data) ? data.data : data;
        if (returned.place) {
          await setLoggedInUI(returned.place);
        } else if (returned.id) {
          const fetched = await fetchPlace(returned.id);
          if (fetched) await setLoggedInUI(fetched);
        } else if (data.data && data.data.place) {
          await setLoggedInUI(data.data.place);
        }

        showSuccess('تم حفظ المكان بنجاح!');
        const preview = document.getElementById('placeImagePreview'); if (preview) preview.innerHTML = '';
        uploadedImages = [];

        await refreshSubscriptionBar();
        loadPlacesForAds();
        const newLogged = getLoggedPlace();
        if (newLogged && newLogged.id) {
          if (typeof checkAdQuotaAndToggle === 'function') checkAdQuotaAndToggle(newLogged.id);
          if (typeof loadAdsForPlace === 'function') loadAdsForPlace(newLogged.id);
        }
      } catch (err) {
        console.error('handlePlaceSubmit error', err);
        showError(err.message || 'حدث خطأ أثناء حفظ المكان');
      } finally {
        showLoading(false);
        if (submitBtn) { submitBtn.disabled = false; submitBtn.innerHTML = oldHtml || '<i class="fas fa-save"></i> حفظ'; }
      }
    }

    async function handleAdSubmit(ev) {
      ev.preventDefault();
      showLoading(true);
      try {
        const form = ev.target;
        const fd = new FormData(form);
        const adData = {
          placeId: fd.get('placeId'),
          adType: fd.get('adType'),
          adTitle: fd.get('adTitle'),
          coupon: fd.get('coupon'),
          adDescription: fd.get('adDescription'),
          startDate: fd.get('startDate'),
          endDate: fd.get('endDate'),
          adStatus: fd.get('adStatus'),
          adActiveStatus: fd.get('adActiveStatus'),
          images: uploadedImages,
          video: uploadedVideos[0] || null
        };

        if (!validateFiles()) { showLoading(false); return; }

        const imageUrls = [];
        for (let i = 0; i < Math.min(adData.images.length, 8); i++) {
          const file = adData.images[i];
          const url = await uploadToGoogleDrive(file, 'ads');
          imageUrls.push({ name: file.name, url });
        }
        let videoUrl = '';
        if (adData.video) videoUrl = await uploadToGoogleDrive(adData.video, 'ads');

        imageUrls.forEach(i => { recentUploads[i.name] = { url: i.url, name: i.name }; });

        const logged = getLoggedPlace();
        const placeIdToSend = (adData.placeId && adData.placeId !== '') ? adData.placeId : (logged && logged.id ? logged.id : '');

        const payloadBase = {
          placeId: placeIdToSend,
          adType: adData.adType,
          adTitle: adData.adTitle,
          adDescription: adData.adDescription,
          startDate: adData.startDate,
          endDate: adData.endDate,
          coupon: adData.coupon || '',
          imageFiles: JSON.stringify(imageUrls.map(i => i.name || '')),
          imageUrls: JSON.stringify(imageUrls.map(i => i.url || '')),
          videoFile: adData.video ? (adData.video.name || '') : '',
          videoUrl: videoUrl || '',
          adStatus: adData.adStatus || '',
          adActiveStatus: adData.adActiveStatus || ''
        };

        if (editingAdId) {
          const resp = await apiPost({ action: 'updateAd', adId: editingAdId, ...payloadBase });
          if (!resp.ok) throw new Error('فشل تحديث الإعلان');
          const data = resp.data;
          if (data && data.success === false) throw new Error(data.error || 'فشل تحديث الإعلان');
          showSuccess('تم تحديث الإعلان');
          if (typeof loadAdsForPlace === 'function') await loadAdsForPlace(placeIdToSend);
          editingAdId = null;
          const submitBtn = document.querySelector('#adForm button[type="submit"]');
          if (submitBtn) submitBtn.textContent = 'حفظ الإعلان';
        } else {
          const resp = await apiPost({ action: 'addAd', ...payloadBase });
          if (!resp.ok) throw new Error('فشل حفظ الإعلان');
          const data = resp.data;
          if (data && data.success === false) throw new Error(data.error || 'فشل حفظ الإعلان');

          const returned = (data && data.data) ? data.data : data;
          const newAdTemp = {
            id: (returned && returned.id) ? returned.id : ('tmp_' + Date.now()),
            placeId: placeIdToSend,
            type: adData.adType,
            title: adData.adTitle,
            description: adData.adDescription,
            startDate: adData.startDate,
            endDate: adData.endDate,
            status: adData.adStatus || adData.adActiveStatus || '',
            images: imageUrls.map(i => ({ name: i.name, url: i.url })),
            videoUrl: videoUrl || ''
          };
          showSuccess('تم حفظ الإعلان');
          prependAdToList(newAdTemp);
        }

        ev.target.reset();
        const ip = document.getElementById('adImagesPreview'); if (ip) ip.innerHTML = '';
        const vp = document.getElementById('adVideoPreview'); if (vp) vp.innerHTML = '';
        uploadedImages = [];
        uploadedVideos = [];

        if (placeIdToSend) {
          if (typeof checkAdQuotaAndToggle === 'function') await checkAdQuotaAndToggle(placeIdToSend);
          if (typeof loadAdsForPlace === 'function') await loadAdsForPlace(placeIdToSend);
        }
      } catch (err) {
        console.error('handleAdSubmit error', err);
        showError(err.message || 'حدث خطأ أثناء حفظ الإعلان');
      } finally {
        showLoading(false);
      }
    }

    async function loadPlacesForAds() {
      const placeSelects = document.querySelectorAll('select[name="placeId"]');
      placeSelects.forEach(ps => { ps.innerHTML = '<option value="">اختر المكان</option>'; });
      const resp = await apiFetch(`${API_URL}?action=places`);
      if (!resp.ok) { updateAdsTabVisibilitySafely(); return; }
      const json = resp.data;
      let places = [];
      if (json && json.success && json.data && Array.isArray(json.data.places)) places = json.data.places;
      else if (json && Array.isArray(json.places)) places = json.places;
      else if (Array.isArray(json)) places = json;
      else if (json && json.data && Array.isArray(json.data)) places = json.data;
      else places = [];

      places.forEach(p => {
        placeSelects.forEach(ps => {
          const opt = document.createElement('option'); opt.value = p.id; opt.textContent = p.name; ps.appendChild(opt);
        });
      });

      const logged = getLoggedPlace();
      if (logged && logged.id) {
        placeSelects.forEach(ps => { ps.value = logged.id; ps.disabled = true; });
        const tabAds = document.getElementById('tab-ads');
        if (tabAds) tabAds.style.display = 'block';
        if (typeof loadAdsForPlace === 'function') loadAdsForPlace(logged.id);
      } else {
        placeSelects.forEach(ps => { ps.disabled = false; });
        const tabAds = document.getElementById('tab-ads');
        if (tabAds) tabAds.style.display = 'none';
      }

      updateAdsTabVisibilitySafely();
    }
    function updateAdsTabVisibilitySafely() {
      if (typeof updateAdsTabVisibility === 'function') updateAdsTabVisibility();
    }
    async function loadAdsForPlace(placeId) {
      if (!placeId) return;
      try {
        const resp = await apiFetch(`${API_URL}?action=ads&placeId=${encodeURIComponent(placeId)}`);
        if (!resp.ok) { console.warn('loadAdsForPlace failed', resp); return; }
        const json = resp.data;
        const ads = (json && json.success && json.data && json.data.ads)
          ? json.data.ads
          : (json && json.ads)
            ? json.ads
            : (json && json.data && json.data)
              ? json.data
              : [];
        renderAdsList(Array.isArray(ads) ? ads : []);
      } catch (err) {
        console.error('loadAdsForPlace error', err);
      }
    }
    function renderAdsList(ads) {
      let c = document.getElementById('adsListContainer');
      if (!c) return;
      c.innerHTML = '';
      if (!ads || ads.length === 0) {
        c.innerHTML = '<p>لا توجد إعلانات حالياً لهذا المحل.</p>';
        return;
      }
      ads.forEach(ad => {
        const card = document.createElement('div'); card.className = 'ad-card';
        const h = document.createElement('h4'); h.textContent = ad.title || '(بدون عنوان)';
        const meta = document.createElement('div'); meta.className = 'meta';
        meta.textContent = `${ad.startDate || ''} — ${ad.endDate || ''} · الحالة: ${ad.status || ''}`;
        const p = document.createElement('p'); p.textContent = ad.description || '';
        card.appendChild(h); card.appendChild(meta); card.appendChild(p);

        if (ad.images && ad.images.length > 0) {
          const imgs = document.createElement('div'); imgs.className = 'ad-images';
          const imagesArr = Array.isArray(ad.images) ? ad.images : (ad.images && typeof ad.images === 'string' ? JSON.parse(ad.images) : []);
          imagesArr.forEach(im => {
            let url = '', name = '';
            if (im && typeof im === 'object') { url = im.url || ''; name = im.name || ''; }
            else if (typeof im === 'string') { name = im; url = ''; }
            if (!url && name && recentUploads[name]) url = recentUploads[name].url;
            if (url) { const img = document.createElement('img'); img.src = url; img.alt = name || ''; imgs.appendChild(img); }
            else if (name) { const wrap = document.createElement('div'); wrap.className = 'img-placeholder-file'; wrap.textContent = name; imgs.appendChild(wrap); }
          });
          card.appendChild(imgs);
        }

        const actions = document.createElement('div'); actions.className = 'ad-actions';
        const editBtn = document.createElement('button'); editBtn.className = 'btn'; editBtn.textContent = 'تعديل'; editBtn.onclick = () => startEditAd(ad);
        const delBtn = document.createElement('button'); delBtn.className = 'btn btn-secondary'; delBtn.textContent = 'حذف'; delBtn.onclick = () => deleteAdConfirm(ad.id);
        actions.appendChild(editBtn); actions.appendChild(delBtn); card.appendChild(actions);
        c.appendChild(card);
      });
    }
    function prependAdToList(ad) {
      const container = document.getElementById('adsListContainer'); if (!container) return;
      const card = document.createElement('div'); card.className = 'ad-card';
      const h = document.createElement('h4'); h.textContent = ad.title || '(بدون عنوان)';
      const meta = document.createElement('div'); meta.className = 'meta';
      meta.textContent = `${ad.startDate || ''} — ${ad.endDate || ''} · الحالة: ${ad.status || ''}`;
      const p = document.createElement('p'); p.textContent = ad.description || '';
      card.appendChild(h); card.appendChild(meta); card.appendChild(p);

      if (ad.images && ad.images.length > 0) {
        const imgs = document.createElement('div'); imgs.className = 'ad-images';
        ad.images.forEach(im => {
          const url = im && im.url ? im.url : ''; const name = im && im.name ? im.name : '';
          if (url) { const img = document.createElement('img'); img.src = url; img.alt = name || ''; imgs.appendChild(img); }
          else if (name) { const wrap = document.createElement('div'); wrap.className = 'img-placeholder-file'; wrap.textContent = name; imgs.appendChild(wrap); }
        });
        card.appendChild(imgs);
      }

      const actions = document.createElement('div'); actions.className = 'ad-actions';
      const editBtn = document.createElement('button'); editBtn.className = 'btn'; editBtn.textContent = 'تعديل'; editBtn.onclick = () => startEditAd(ad);
      const delBtn = document.createElement('button'); delBtn.className = 'btn btn-secondary'; delBtn.textContent = 'حذف'; delBtn.onclick = () => deleteAdConfirm(ad.id);
      actions.appendChild(editBtn); actions.appendChild(delBtn); card.appendChild(actions);
      container.insertBefore(card, container.firstChild);
    }

    function startEditAd(ad) {
      try {
        editingAdId = ad.id || null;
        const form = document.getElementById('adForm');
        if (!form) return;
        form.querySelector('select[name="placeId"]').value = ad.placeId || '';
        form.querySelector('select[name="adType"]').value = ad.type || '';
        form.querySelector('input[name="adTitle"]').value = ad.title || '';
        form.querySelector('input[name="coupon"]').value = ad.coupon || '';
        form.querySelector('textarea[name="adDescription"]').value = ad.description || '';
        form.querySelector('input[name="startDate"]').value = ad.startDate || '';
        form.querySelector('input[name="endDate"]').value = ad.endDate || '';
        form.querySelector('select[name="adActiveStatus"]').value = ad.adActiveStatus || ad.status || '';
        form.querySelector('select[name="adStatus"]').value = ad.adStatus || ad.status || '';

        const ip = document.getElementById('adImagesPreview');
        if (ip) {
          ip.innerHTML = '';
          const imgArr = Array.isArray(ad.images) ? ad.images : (ad.images && typeof ad.images === 'string' ? JSON.parse(ad.images) : []);
          imgArr.forEach(im => {
            const url = im && im.url ? im.url : (typeof im === 'string' ? im : '');
            const name = im && im.name ? im.name : (typeof im === 'string' ? im : '');
            const div = document.createElement('div'); div.className = 'preview-image';
            if (url) {
              const img = document.createElement('img'); img.src = url; img.style.width = '100%'; img.style.height = '90px'; img.style.objectFit = 'cover';
              div.appendChild(img);
            } else if (name && recentUploads[name]) {
              const img = document.createElement('img'); img.src = recentUploads[name].url; img.style.width = '100%'; img.style.height = '90px'; img.style.objectFit = 'cover';
              div.appendChild(img);
            } else if (name) {
              const placeholder = document.createElement('div'); placeholder.className = 'img-placeholder-file'; placeholder.textContent = name;
              div.appendChild(placeholder);
            }
            ip.appendChild(div);
          });
        }
        const vp = document.getElementById('adVideoPreview');
        if (vp) {
          vp.innerHTML = '';
          if (ad.videoUrl) {
            const video = document.createElement('video'); video.src = ad.videoUrl; video.controls = true; video.style.width = '100%';
            vp.appendChild(video);
          }
        }
        const submitBtn = document.querySelector('#adForm button[type="submit"]');
        if (submitBtn) submitBtn.textContent = 'تحديث الإعلان';
        showTab('ads');
      } catch (e) {
        console.error('startEditAd failed', e);
      }
    }
    async function deleteAdConfirm(adId) {
      if (!confirm('هل أنت متأكد من حذف هذا الإعلان؟ لا يمكن التراجع.')) return;
      try {
        const resp = await apiPost({ action: 'deleteAd', adId });
        if (!resp.ok) throw new Error('فشل حذف الإعلان');
        const data = resp.data;
        if (data && data.success === false) throw new Error(data.error || 'فشل حذف الإعلان');
        showSuccess('تم حذف الإعلان');
        const logged = getLoggedPlace();
        if (logged && logged.id) {
          if (typeof checkAdQuotaAndToggle === 'function') checkAdQuotaAndToggle(logged.id);
          if (typeof loadAdsForPlace === 'function') loadAdsForPlace(logged.id);
        }
      } catch (err) {
        console.error('deleteAd error', err);
        showError(err.message || 'خطأ أثناء حذف الإعلان');
      }
    }

    async function checkAdQuotaAndToggle(placeId) {
      try {
        if (!placeId) {
          const tabAds = document.getElementById('tab-ads');
          if (tabAds) tabAds.style.display = 'none';
          return;
        }
        const resp = await apiFetch(`${API_URL}?action=remainingAds&placeId=${encodeURIComponent(placeId)}`);
        if (!resp.ok) { toggleAdFormAllowed(false, 'تعذر التحقق من الباقة'); return; }
        const data = resp.data && resp.data.data ? resp.data.data : resp.data;
        const remaining = Number((data && data.remaining) || 0);
        const allowed = Number((data && data.allowed) || 0);
        const used = Number((data && data.used) || 0);
        showAdQuotaMessage(`الإعلانات: الكل ${allowed} · المستخدمة ${used} · المتبقي ${remaining}`);
        toggleAdFormAllowed(remaining > 0, remaining > 0 ? '' : 'استنفدت حصة الإعلانات');
      } catch (err) {
        console.error('checkAdQuotaAndToggle', err);
        toggleAdFormAllowed(false, 'خطأ أثناء التحقق');
      }
    }
    function toggleAdFormAllowed(allowed, message) {
      const adForm = document.getElementById('adForm'); if (!adForm) return;
      const submitBtn = adForm.querySelector('button[type="submit"]');
      if (submitBtn) {
        submitBtn.disabled = !allowed;
        submitBtn.style.opacity = allowed ? '1' : '0.6';
        submitBtn.title = allowed ? '' : (message || 'غير مسموح');
      }
      let adNotice = document.getElementById('adQuotaNotice');
      if (!adNotice) {
        const container = document.getElementById('ads-tab');
        if (container) {
          adNotice = document.createElement('div');
          adNotice.id = 'adQuotaNotice';
          adNotice.style.background = '#fff3cd';
          adNotice.style.color = '#856404';
          adNotice.style.padding = '10px';
          adNotice.style.borderRadius = '6px';
          adNotice.style.marginTop = '12px';
          container.insertBefore(adNotice, container.firstChild.nextSibling);
        }
      }
      if (adNotice) {
        adNotice.textContent = message || '';
        adNotice.style.display = message ? 'block' : 'none';
      }
    }
    function showAdQuotaMessage(text) {
      let el = document.getElementById('adQuotaSummary');
      if (!el) {
        const container = document.getElementById('ads-tab'); if (!container) return;
        el = document.createElement('p'); el.id = 'adQuotaSummary'; el.style.marginTop = '8px'; el.style.color = '#333';
        container.insertBefore(el, container.firstChild.nextSibling);
      }
      el.textContent = text || '';
    }
    function updateAdsTabVisibility() {
      const adsTab = document.getElementById('tab-ads');
      const logged = getLoggedPlace();
      if (!adsTab) return;
      if (logged && logged.id) adsTab.style.display = 'block';
      else {
        adsTab.style.display = 'none';
        const activeTab = document.querySelector('.tab.active');
        if (!activeTab || activeTab.id === 'tab-ads') {
          const placesTabEl = document.getElementById('tab-places');
          if (placesTabEl) { placesTabEl.classList.add('active'); showTab('places'); }
        }
      }
    }

    async function fetchPlace(placeId) {
      if (!API_URL || !API_URL.startsWith('http')) return null;
      const resp = await apiPost({ action: 'getDashboard', placeId });
      if (!resp.ok) return null;
      const data = resp.data;
      if (!data || data.success === false) return null;
      return (data.data && data.data.place) ? data.data.place : null;
    }

    function setupAuthUI() {
      const loginBtn = document.getElementById('loginBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      const loginModal = document.getElementById('loginModal');
      const loginCancel = document.getElementById('loginCancel');
      const loginForm = document.getElementById('loginForm');
      if (loginBtn) loginBtn.addEventListener('click', () => { if (loginModal) loginModal.style.display = 'flex'; });
      if (loginCancel) loginCancel.addEventListener('click', () => { if (loginModal) loginModal.style.display = 'none'; });
      if (loginModal) loginModal.addEventListener('click', ev => { if (ev.target === loginModal) loginModal.style.display = 'none'; });
      if (loginForm) loginForm.addEventListener('submit', handleLoginSubmit);
      if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);
      const stored = getLoggedPlace();
      if (stored) setLoggedInUI(stored);
      if (typeof updateAdsTabVisibility === 'function') updateAdsTabVisibility();
    }
    function getLoggedPlace() {
      try { const raw = localStorage.getItem('khedmatak_place'); return raw ? JSON.parse(raw) : null; } catch { return null; }
    }
    function setLoggedPlace(obj) {
      try { localStorage.setItem('khedmatak_place', JSON.stringify(obj)); } catch {}
    }
    function clearLoggedPlace() { try { localStorage.removeItem('khedmatak_place'); } catch {} }

    async function handleLoginSubmit(ev) {
      ev.preventDefault();
      showLoading(true);
      try {
        const form = ev.target;
        const phoneOrId = (form.querySelector('input[name="phoneOrId"]')?.value || '').trim();
        const password = form.querySelector('input[name="password"]')?.value || '';
        if (!phoneOrId || !password) { showError('ادخل رقم/ID وكلمة المرور'); return; }

        const resp = await apiPost({ action: 'loginPlace', phoneOrId, password });
        if (!resp.ok) throw new Error('خطأ في التواصل مع الخادم');

        const root = resp.data;
        if (!root || root.success === false) {
          const errMsg = (root && root.error) ? root.error : 'تعذر تسجيل الدخول';
          throw new Error(errMsg);
        }

        const payload = (root && root.data) ? root.data : root;
        const placeObj = payload.place || payload.Place || null;

        if (!placeObj || !placeObj.raw) {
          console.warn('Unexpected login response shape:', root);
          throw new Error('تعذر استخراج بيانات المكان من الاستجابة');
        }

        if (!placeObj.name && placeObj.raw && placeObj.raw['اسم المكان']) placeObj.name = placeObj.raw['اسم المكان'];

        await setLoggedInUI(placeObj);
        showSuccess('تم تسجيل الدخول');
      } catch (err) {
        console.error('Login error:', err);
        showError(err.message || 'خطأ أثناء الدخول');
      } finally {
        showLoading(false);
      }
    }
    function handleLogout() {
      setLoggedOutUI();
      showSuccess('تم تسجيل الخروج');
    }
    async function setLoggedInUI(place) {
      const loginBtn = document.getElementById('loginBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      const loggedInUser = document.getElementById('loggedInUser');
      if (loginBtn) loginBtn.style.display = 'none';
      if (logoutBtn) logoutBtn.style.display = 'inline-block';
      if (loggedInUser) {
        loggedInUser.style.display = 'inline-block';
        const name = (place && (place.name || (place.raw && place.raw['اسم المكان']))) || 'صاحب المحل';
        loggedInUser.textContent = name;
      }
      const loginModal = document.getElementById('loginModal'); if (loginModal) loginModal.style.display = 'none';

      if (place && !place.name && place.raw && place.raw['اسم المكان']) place.name = place.raw['اسم المكان'];

      setLoggedPlace(place);
      await loadLookupsAndPopulate().catch(() => {});
      await tryPrefillPlaceForm(place);
      const tabAds = document.getElementById('tab-ads'); if (tabAds) tabAds.style.display = 'block';
      const placeSelects = document.querySelectorAll('select[name="placeId"]');
      placeSelects.forEach(ps => { ps.value = place.id; ps.disabled = true; });
      if (typeof updateAdsTabVisibility === 'function') updateAdsTabVisibility();
      if (place.id) {
        if (typeof checkAdQuotaAndToggle === 'function') checkAdQuotaAndToggle(place.id);
        if (typeof loadAdsForPlace === 'function') loadAdsForPlace(place.id);
      }
      try { showPlaceStatusBar(place); } catch (e) { console.warn('could not show status bar', e); }
      await refreshSubscriptionBar();
    }
    function setLoggedOutUI() {
      const loginBtn = document.getElementById('loginBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      const loggedInUser = document.getElementById('loggedInUser');
      if (loginBtn) loginBtn.style.display = 'inline-block';
      if (logoutBtn) logoutBtn.style.display = 'none';
      if (loggedInUser) { loggedInUser.style.display = 'none'; loggedInUser.textContent = ''; }
      clearLoggedPlace();
      hidePlaceStatusBar();
      // إخفاء شريط الاشتراك
      const subscriptionBar = document.getElementById('subscriptionStatusBar');
      if (subscriptionBar) subscriptionBar.style.display = 'none';
      const tabAds = document.getElementById('tab-ads'); if (tabAds) tabAds.style.display = 'none';
      const placeSelects = document.querySelectorAll('select[name="placeId"]'); placeSelects.forEach(ps => { ps.disabled = false; });
      if (typeof updateAdsTabVisibility === 'function') updateAdsTabVisibility();
    }

    function initPlaceStatusButtons() {
      const container = document.getElementById('placeStatusButtons');
      if (!container) return;
      container.querySelectorAll('.status-btn').forEach(btn => {
        const clone = btn.cloneNode(true);
        btn.parentNode.replaceChild(clone, btn);
      });
      const buttons = document.querySelectorAll('#placeStatusButtons .status-btn');
      buttons.forEach(btn => {
        btn.addEventListener('click', async () => {
          const status = btn.dataset.status; if (!status) return;
          await updatePlaceStatus(status, btn);
        });
      });
    }
    function showPlaceStatusBar(place) {
      const bar = document.getElementById('placeStatusBar');
      const msg = document.getElementById('placeStatusMessage');
      if (!bar) return;
      if (!place || !place.id) { bar.style.display = 'none'; if (msg) msg.textContent = ''; return; }
      bar.style.display = 'block';
      const current = (place.status && String(place.status).trim() !== '')
        ? place.status
        : (place.raw && (place.raw['حالة المكان'] || place.raw['حالة التسجيل']))
          ? (place.raw['حالة المكان'] || place.raw['حالة التسجيل'])
          : '';
      const buttons = document.querySelectorAll('#placeStatusButtons .status-btn');
      buttons.forEach(b => {
        b.classList.toggle('active', b.dataset.status === current);
        b.disabled = false;
        b.textContent = b.dataset.status;
      });
      if (msg) msg.textContent = current ? `الحالة الحالية: ${current}` : 'الحالة غير محددة';
      initPlaceStatusButtons();
    }
    function hidePlaceStatusBar() {
      const bar = document.getElementById('placeStatusBar');
      const msg = document.getElementById('placeStatusMessage');
      if (bar) bar.style.display = 'none';
      if (msg) msg.textContent = '';
    }
    async function updatePlaceStatus(newStatus, btnElement = null) {
      let originalText = null;
      try {
        const logged = getLoggedPlace();
        const placeId = (logged && logged.id) ? logged.id : (logged && logged.placeId) ? logged.placeId : null;
        if (!placeId) throw new Error('لا يوجد مكان مسجّل للدخول');

        const current = (logged && logged.status)
          ? logged.status
          : (logged && logged.raw && (logged.raw['حالة المكان'] || logged.raw['حالة التسجيل']))
            ? (logged.raw['حالة المكان'] || logged.raw['حالة التسجيل'])
            : '';
        if (String(current) === String(newStatus)) {
          document.querySelectorAll('#placeStatusButtons .status-btn').forEach(b => b.classList.toggle('active', b.dataset.status === newStatus));
          const msg = document.getElementById('placeStatusMessage'); if (msg) msg.textContent = `الحالة: ${newStatus}`;
          return;
        }

        const buttons = document.querySelectorAll('#placeStatusButtons .status-btn'); buttons.forEach(b => b.disabled = true);

        if (btnElement) { originalText = btnElement.textContent; btnElement.textContent = 'جاري الحفظ...'; }

        const resp = await apiPost({ action: 'updatePlace', placeId, status: newStatus });
        if (!resp.ok) throw new Error('فشل في التواصل مع الخادم');
        const data = resp.data;
        if (!data || data.success === false) throw new Error((data && data.error) ? data.error : 'استجابة غير متوقعة');

        const stored = getLoggedPlace() || {};
        stored.status = newStatus;
        if (!stored.raw) stored.raw = {};
        stored.raw['حالة المكان'] = newStatus;
        stored.raw['حالة التسجيل'] = newStatus;
        setLoggedPlace(stored);

        buttons.forEach(b => { b.classList.toggle('active', b.dataset.status === newStatus); b.disabled = false; b.textContent = b.dataset.status; });

        if (btnElement && originalText !== null) btnElement.textContent = btnElement.dataset.status;
        const msg = document.getElementById('placeStatusMessage'); if (msg) msg.textContent = `تم التحديث إلى: ${newStatus}`;
        showSuccess('تم تحديث حالة المكان');
      } catch (err) {
        console.error('updatePlaceStatus error', err);
        showError(err.message || 'فشل تحديث حالة المكان');
        document.querySelectorAll('#placeStatusButtons .status-btn').forEach(b => { b.disabled = false; b.textContent = b.dataset.status; });
        if (btnElement && originalText !== null) btnElement.textContent = originalText;
      }
    }

    function parseLatLngFromMapLink(url) {
      if (!url || typeof url !== 'string') return null;
      try {
        url = url.trim();
        let m = url.match(/@(-?\\d+\\.\\d+),\\s*(-?-?\\d+\\.\\d+)/);
        if (m) return { lat: parseFloat(m[1]), lng: parseFloat(m[2]) };
        m = url.match(/!3d(-?\\d+\\.\\d+)!4d(-?\\d+\\.\\d+)/);
        if (m) return { lat: parseFloat(m[1]), lng: parseFloat(m[2]) };
        m = url.match(/[?&]q=(-?\\d+\\.\\d+),(-?\\d+\\.\\d+)/);
        if (m) return { lat: parseFloat(m[1]), lng: parseFloat(m[2]) };
        m = url.match(/[?&]ll=(-?\\d+\\.\\d+),(-?\\d+\\.\\d+)/);
        if (m) return { lat: parseFloat(m[1]), lng: parseFloat(m[2]) };
        m = url.match(/[?&]mlat=(-?\\d+\\.\\d+)&mlon=(-?\\d+\\.\\d+)/);
        if (m) return { lat: parseFloat(m[1]), lng: parseFloat(m[2]) };
        m = url.match(/#map=\\d+\\/(-?\\d+\\.\\d+)\\/(-?\\d+\\.\\d+)/);
        if (m) return { lat: parseFloat(m[1]), lng: parseFloat(m[2]) };
        m = url.match(/(-?\\d+\\.\\d+)[, ]\\s*(-?\\d+\\.\\d+)/);
        if (m) {
          const lat = parseFloat(m[1]), lng = parseFloat(m[2]);
          if (Math.abs(lat) <= 90 && Math.abs(lng) <= 180) return { lat, lng };
        }
      } catch (e) { console.warn('parseLatLngFromMapLink error', e); }
      return null;
    }
    async function reverseGeocodeNominatim(lat, lng) {
      try {
        const url = \`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=\${encodeURIComponent(lat)}&lon=\${encodeURIComponent(lng)}&addressdetails=1\`;
        const res = await fetch(url, { headers: { 'Accept': 'application/json', 'User-Agent': 'Khedmatak-App/1.0 (contact@example.com)' } });
        if (!res.ok) return null;
        return await res.json();
      } catch (e) { console.warn('reverseGeocodeNominatim error', e); return null; }
    }
    async function autoFillFromMapLink(url) {
      if (!url || String(url).trim() === '') return;
      const coords = parseLatLngFromMapLink(url);
      if (!coords) return;
      const geo = await reverseGeocodeNominatim(coords.lat, coords.lng);
      if (!geo) return;
      const detailed = geo.display_name || '';
      const address = geo.address || {};
      const detailedEl = document.querySelector('input[name="detailedAddress"]');
      if (detailedEl && (!detailedEl.value || detailedEl.value.trim() === '')) detailedEl.value = detailed;
      const cityCandidates = [address.city, address.town, address.village, address.county, address.state];
      const areaCandidates = [address.suburb, address.neighbourhood, address.hamlet, address.village, address.city_district];
      const cityVal = cityCandidates.find(Boolean);
      const areaVal = areaCandidates.find(Boolean);
      if (cityVal) { await setSelectValueWhenReady('select[name="city"]', cityVal); try { updateAreas(); } catch {} }
      if (areaVal) { await setSelectValueWhenReady('select[name="area"]', areaVal); }
    }
    function initMapLinkAutoFill() {
      const mapInput = document.querySelector('input[name="mapLink"]');
      if (!mapInput) return;
      let timer = null;
      const run = () => { const v = mapInput.value; if (v && v.trim() !== '') autoFillFromMapLink(v.trim()); };
      mapInput.addEventListener('blur', run);
      mapInput.addEventListener('input', () => { if (timer) clearTimeout(timer); timer = setTimeout(run, 900); });
    }

    function buildGoogleMapsLink(lat, lng) {
      return \`https://www.google.com/maps/search/?api=1&query=\${encodeURIComponent(lat + ',' + lng)}\`;
    }
    async function handlePositionAndFill(lat, lng) {
      try {
        const mapEl = document.querySelector('input[name="mapLink"]') || document.getElementById('mapLinkInput');
        if (mapEl) {
          mapEl.value = buildGoogleMapsLink(lat, lng);
          try { mapEl.dispatchEvent(new Event('input', { bubbles: true })); } catch {}
          try { mapEl.dispatchEvent(new Event('change', { bubbles: true })); } catch {}
        }
        const geo = await reverseGeocodeNominatim(lat, lng);
        if (!geo) return;
        const detailed = geo.display_name || '';
        const address = geo.address || {};
        const detailedEl = document.querySelector('input[name="detailedAddress"]');
        if (detailedEl && (!detailedEl.value || detailedEl.value.trim() === '')) detailedEl.value = detailed;
        const cityCandidates = [address.city, address.town, address.village, address.county, address.state];
        const areaCandidates = [address.suburb, address.neighbourhood, address.hamlet, address.village, address.city_district];
        const cityVal = cityCandidates.find(Boolean);
        if (cityVal) { await setSelectValueWhenReady('select[name="city"]', cityVal); try { updateAreas(); } catch {} }
        const areaVal = areaCandidates.find(Boolean);
        if (areaVal) { await setSelectValueWhenReady('select[name="area"]', areaVal); }
      } catch (e) { console.error('handlePositionAndFill error', e); }
    }
    function requestGeolocationOnce(options = { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 }) {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) return reject(new Error('Geolocation not supported'));
        navigator.geolocation.getCurrentPosition(pos => resolve(pos), err => reject(err), options);
      });
    }
    async function attemptAutoLocate(showMessages = true) {
      const mapInput = document.querySelector('input[name="mapLink"]') || document.getElementById('mapLinkInput');
      if (mapInput && mapInput.value && mapInput.value.trim() !== '') return;
      try {
        if (showMessages) showSuccess('جاري محاولة تحديد موقعك...');
        const pos = await requestGeolocationOnce();
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        await handlePositionAndFill(lat, lng);
        if (showMessages) showSuccess('تم تحديد الموقع وملأ الحقول تلقائياً');
      } catch {
        if (showMessages) showError('تعذر الحصول على الموقع. تأكد من منح الإذن أو اضغط "استخدم موقعي"');
      }
    }
    function initMapAutoLocate() {
      const btn = document.getElementById('autoLocateBtn');
      if (btn) {
        btn.addEventListener('click', async () => {
          btn.disabled = true;
          const old = btn.textContent;
          btn.textContent = 'جاري تحديد الموقع...';
          await attemptAutoLocate(true);
          btn.disabled = false;
          btn.textContent = old;
        });
      }
      setTimeout(() => { try { attemptAutoLocate(false); } catch {} }, 900);
    }

    function setSelectByValueOrText(selectEl, val) {
      if (!selectEl) return false;
      const str = (val === null || val === undefined) ? '' : String(val).trim();
      if (!str) return false;
      for (let i = 0; i < selectEl.options.length; i++) if (String(selectEl.options[i].value) === str) { selectEl.value = selectEl.options[i].value; return true; }
      for (let i = 0; i < selectEl.options.length; i++) if (String(selectEl.options[i].text).trim() === str) { selectEl.value = selectEl.options[i].value; return true; }
      for (let i = 0; i < selectEl.options.length; i++) if (String(selectEl.options[i].text).toLowerCase().includes(str.toLowerCase())) { selectEl.value = selectEl.options[i].value; return true; }
      return false;
    }
    function setSelectValueWhenReady(selector, val, retries = 12, interval = 200) {
      return new Promise(resolve => {
        if (!selector || val === null || val === undefined || String(val).trim() === '') { resolve(false); return; }
        let attempts = 0;
        const trySet = () => {
          attempts++;
          const sel = (typeof selector === 'string') ? document.querySelector(selector) : selector;
          if (sel) {
            const ok = setSelectByValueOrText(sel, val);
            if (ok) { resolve(true); return; }
          }
          if (attempts >= retries) { resolve(false); return; }
          setTimeout(trySet, interval);
        };
        trySet();
      });
    }
    function showSuccess(message) {
      const el = document.getElementById('successAlert'); if (!el) return;
      el.textContent = message; el.className = 'alert alert-success'; el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 4000);
    }
    function showError(message) {
      const el = document.getElementById('errorAlert'); if (!el) return;
      el.textContent = message; el.className = 'alert alert-error'; el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 5000);
    }
    function showLoading(show) {
      const el = document.getElementById('loading'); if (!el) return;
      el.style.display = show ? 'block' : 'none';
    }

    function validateFiles() {
      const maxImageSize = 10 * 1024 * 1024;   // 10MB
      const maxVideoSize = 50 * 1024 * 1024;   // 50MB
      const allowedImageTypes = ['image/jpeg','image/png','image/gif','image/webp'];
      const allowedVideoTypes = ['video/mp4','video/avi','video/mov','video/quicktime'];

      for (let img of uploadedImages) {
        if (img.size > maxImageSize) { showError('حجم الصورة أكبر من 10MB'); return false; }
        if (!allowedImageTypes.includes(img.type)) { showError('نوع الصورة غير مدعوم'); return false; }
      }
      if (uploadedVideos.length > 0) {
        const vid = uploadedVideos[0];
        if (vid.size > maxVideoSize) { showError('حجم الفيديو أكبر من 50MB'); return false; }
        if (!allowedVideoTypes.includes(vid.type)) { showError('نوع الفيديو غير مدعوم'); return false; }
      }
      return true;
    }

    function parseDateISO(d) {
      if (!d) return null;
      try {
        if (d instanceof Date) return d;
        const s = String(d).trim();
        if (!s) return null;
        const parts = s.split('-');
        if (parts.length === 3) {
          const y = Number(parts[0]), m = Number(parts[1]) - 1, day = Number(parts[2]);
          const dt = new Date(y, m, day); dt.setHours(23,59,59,999); return dt;
        }
        const dt2 = new Date(s);
        return isNaN(dt2.getTime()) ? null : dt2;
      } catch { return null; }
    }
    function daysBetween(from, to) {
      if (!from || !to) return null;
      const d1 = new Date(from.getFullYear(), from.getMonth(), from.getDate());
      const d2 = new Date(to.getFullYear(), to.getMonth(), to.getDate());
      const ms = d2 - d1;
      return Math.ceil(ms / (1000 * 60 * 60 * 24));
    }
    function diffDaysHours(from, to) {
      if (!from || !to) return { days: null, hours: null, ms: null };
      let diff = to.getTime() - from.getTime();
      if (diff < 0) diff = 0;
      const dayMs = 86400000, hourMs = 3600000;
      const days = Math.floor(diff / dayMs); diff -= days * dayMs;
      const hours = Math.floor(diff / hourMs);
      return { days, hours, ms: to.getTime() - from.getTime() };
    }

    // الشريط الثابت للاشتراك
    async function refreshSubscriptionBar() {
      try {
        const logged = getLoggedPlace();
        const subscriptionBar = document.getElementById('subscriptionStatusBar');
        const subscriptionTitle = document.getElementById('subscriptionTitle');
        const subscriptionDetails = document.getElementById('subscriptionDetails');
        const subscriptionCountdown = document.getElementById('subscriptionCountdown');

        if (subscriptionBar) subscriptionBar.style.display = 'none';
        if (subscriptionTitle) subscriptionTitle.textContent = '';
        if (subscriptionDetails) subscriptionDetails.textContent = '';
        if (subscriptionCountdown) { subscriptionCountdown.textContent = ''; clearInterval(subscriptionCountdown._timer); }

        if (!logged || !logged.id) return;

        const resp = await apiPost({ action: 'getDashboard', placeId: logged.id });
        if (!resp.ok || !resp.data) return;
        const payload = resp.data.data || resp.data;
        const place = payload.place || null;
        if (!place || !place.raw) return;

        const pkgStatus = String(place.raw['حالة الباقة'] || '').trim();
        const pkgId = String(place.raw['الباقة'] || '').trim();
        const startDate = parseDateISO(place.raw['تاريخ بداية الاشتراك'] || '');
        const endDate = parseDateISO(place.raw['تاريخ نهاية الاشتراك'] || '');

        let packageName = '';
        try {
          if (window.lastLookups && Array.isArray(lastLookups.packages)) {
            const found = lastLookups.packages.find(p => String(p.id) === pkgId);
            if (found) packageName = found.name;
          }
        } catch {}

        const today = new Date();
        let remainingDays = (startDate && endDate) ? daysBetween(today, endDate) : null;
        if (remainingDays !== null && remainingDays < 0) remainingDays = 0;

        function setupCountdown(el, end) {
          if (!el || !end) return;
          const update = () => {
            const dh = diffDaysHours(new Date(), end);
            const days = dh.days ?? 0; const hours = dh.hours ?? 0;
            el.textContent = `${days} يوم و${hours} ساعة`;
          };
          update();
          clearInterval(el._timer);
          el._timer = setInterval(update, 60000);
        }

        const showBar = () => { if (subscriptionBar) subscriptionBar.style.display = 'block'; };

        if (!pkgStatus) {
          showBar();
          if (subscriptionTitle) subscriptionTitle.textContent = 'لا يوجد اشتراك نشط';
          if (subscriptionDetails) subscriptionDetails.textContent = 'اختر باقة لبدء الاشتراك';
          if (subscriptionCountdown) subscriptionCountdown.textContent = '';
          return;
        }

        if (pkgStatus === 'نشطة') {
          showBar();
          const pn = packageName || (pkgId ? `ID ${pkgId}` : 'غير معروفة');
          const eTxt = endDate ? endDate.toISOString().split('T')[0] : '';
          const remTxt = remainingDays !== null ? ` • المتبقي ${remainingDays} يوم` : '';
          if (subscriptionTitle) subscriptionTitle.textContent = `📦 ${pn}`;
          if (subscriptionDetails) subscriptionDetails.textContent = `${eTxt ? `تنتهي في ${eTxt}` : ''}${remTxt}`;
          if (endDate && subscriptionCountdown) setupCountdown(subscriptionCountdown, endDate);
          return;
        }

        if (pkgStatus === 'قيد الدفع') {
          showBar();
          const pn = packageName || (pkgId ? `ID ${pkgId}` : 'غير معروفة');
          if (subscriptionTitle) subscriptionTitle.textContent = `⏳ ${pn}`;
          if (subscriptionDetails) subscriptionDetails.textContent = 'قيد الدفع - ارفق إيصال الدفع لتفعيل الباقة';
          if (subscriptionCountdown) subscriptionCountdown.textContent = 'في الانتظار';
          return;
        }

        if (pkgStatus === 'منتهية') {
          showBar();
          const pn = packageName || (pkgId ? `ID ${pkgId}` : 'غير معروفة');
          const eTxt = endDate ? endDate.toISOString().split('T')[0] : '';
          if (subscriptionTitle) subscriptionTitle.textContent = `❌ ${pn}`;
          if (subscriptionDetails) subscriptionDetails.textContent = `انتهت${eTxt ? ` في ${eTxt}` : ''} - جدد اشتراكك من قسم الباقات`;
          if (subscriptionCountdown) subscriptionCountdown.textContent = 'منتهية';
          return;
        }

        showBar();
        const pn = packageName || (pkgId ? `ID ${pkgId}` : 'غير معروفة');
        if (subscriptionTitle) subscriptionTitle.textContent = `📋 ${pn}`;
        if (subscriptionDetails) subscriptionDetails.textContent = `الحالة: ${pkgStatus}`;
      } catch (e) {
        console.warn('refreshSubscriptionBar error', e);
      }
    }

    async function checkIfTrialIsUsed(placeId) {
      try {
        const resp = await apiPost({ action: 'getDashboard', placeId });
        if (!resp.ok) return false;
        const data = resp.data && resp.data.data ? resp.data.data : resp.data;
        const place = data && data.place ? data.place : null;
        if (!place || !place.raw) return false;
        const trialUsed = String(place.raw['حالة الباقة التجريبية']).toLowerCase() === 'true';
        const pkgStatus = String(place.raw['حالة الباقة'] || '').trim();
        if (trialUsed && pkgStatus === 'منتهية') return true;
        return false;
      } catch { return false; }
    }

    async function choosePackageAPI(packageId, options = {}) {
      const logged = getLoggedPlace();
      if (!logged || !logged.id) { showError('يجب تسجيل الدخول أولاً'); return; }

      const price = Number(options.price || 0);

      try {
        const payload = { action: 'choosePackage', placeId: logged.id, packageId };
        if (price === 0) payload.free = true;

        const resp = await apiPost(payload);
        if (!resp.ok) { showError(price === 0 ? 'تعذر تفعيل الباقة المجانية' : 'فشل تغيير الباقة'); return; }
        const root = resp.data;
        if (!root || root.success === false) {
          showError((root && root.error) || (price === 0 ? 'تعذر تفعيل الباقة المجانية' : 'فشل تغيير الباقة'));
          return;
        }

        const returned = (root && root.data) ? root.data : root;

        if (price === 0 || (returned && returned.pending === false)) {
          const place = getLoggedPlace() || {};
          place.raw = place.raw || {};
          place.raw['الباقة'] = String(packageId);
          place.raw['حالة الباقة'] = 'نشطة';
          if (returned.start) place.raw['تاريخ بداية الاشتراك'] = returned.start;
          if (returned.end) place.raw['تاريخ نهاية الاشتراك'] = returned.end;
          if (returned.trialActivated) place.raw['حالة الباقة التجريبية'] = 'true';
          setLoggedPlace(place);
          showSuccess('تم تفعيل الباقة بنجاح');
        } else if (returned && returned.pending === true) {
          const paymentId = returned.paymentId || returned.paymentID || returned.id;
          const amount = returned.amount || returned.price || '';
          const currency = returned.currency || 'SAR';
          showPaymentModal({ paymentId, amount, currency, placeId: logged.id });

          const place = getLoggedPlace() || {};
          place.raw = place.raw || {};
          place.raw['الباقة'] = String(packageId);
          place.raw['حالة الباقة'] = 'قيد الدفع';
          setLoggedPlace(place);
          showSuccess('تم إنشاء طلب دفع. اتبع الإرشادات لإرسال إيصال الدفع.');
        } else {
          showSuccess(returned.message || 'تم تحديث الباقة');
        }
      } catch (err) {
        console.error('choosePackageAPI error', err);
        showError(err.message || 'فشل تغيير/تفعيل الباقة');
      } finally {
        await refreshSubscriptionBar();
        try { await loadLookupsAndPopulate(); } catch {}
      }
    }

    function showPaymentModal({ paymentId, amount, currency, placeId }) {
      const existing = document.getElementById('pm_modal'); if (existing) existing.remove();

      const modal = document.createElement('div');
      modal.id = 'pm_modal';
      modal.style = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';
      modal.innerHTML = \`
        <div style="background:#fff;padding:18px;border-radius:10px;max-width:720px;width:95%;direction:rtl;color:#111">
          <h3 style="margin-top:0">معلومات الدفع</h3>
          \${paymentId ? \`<p>معرف طلب الدفع: <strong id="pm_paymentId">\${escapeHtml(paymentId)}</strong></p>\` : '<p>لا يوجد معرف طلب دفع متاح حالياً.</p>'}
          \${amount ? \`<p>المبلغ المطلوب: <strong>\${escapeHtml(String(amount))} \${escapeHtml(String(currency || 'SAR'))}</strong></p>\` : ''}
          <h4>طرق الدفع المتاحة</h4>
          <div id="pm_methods" style="margin-bottom:8px"></div>
          <label style="display:block;margin-top:8px">ارفق إيصال الدفع (صورة)</label>
          <input type="file" id="pm_receipt" accept="image/*" style="display:block;margin:8px 0" />
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
            <button id="pm_cancel" class="btn btn-secondary">إلغاء</button>
            <button id="pm_send" class="btn btn-primary">أرسل الإيصال</button>
          </div>
          <div id="pm_msg" style="margin-top:10px;color:#333"></div>
        </div>
      \`;
      document.body.appendChild(modal);

      const methodsContainer = modal.querySelector('#pm_methods');
      const methods = window.availablePaymentMethods || [];
      if (methods && methods.length) {
        methods.forEach(m => {
          const div = document.createElement('div');
          div.style = 'padding:8px;border-radius:6px;border:1px solid #eee;margin-bottom:6px;background:#fafafa';
          const name = m.name || m['طرق الدفع'] || (m.raw && (m.raw['طرق الدفع'] || m.raw['طريقة الدفع'])) || 'طريقة دفع';
          const id = (m.raw && (m.raw['معرف الدفع'] || m.id)) ? (m.raw['معرف الدفع'] || m.id) : '';
          div.innerHTML = \`<strong style="display:block">\${escapeHtml(name)}</strong>\${id ? \`<div style="color:#666;margin-top:4px">تفاصيل: \${escapeHtml(String(id))}</div>\` : ''}\`;
          methodsContainer.appendChild(div);
        });
      } else {
        methodsContainer.textContent = 'لا توجد طرق دفع معرفة. تواصل مع الإدارة.';
      }

      const inputFile = modal.querySelector('#pm_receipt');
      const btnCancel = modal.querySelector('#pm_cancel');
      const btnSend = modal.querySelector('#pm_send');
      const msg = modal.querySelector('#pm_msg');

      btnCancel.addEventListener('click', () => modal.remove());

      btnSend.addEventListener('click', async () => {
        if (!inputFile.files || inputFile.files.length === 0) {
          msg.textContent = 'الرجاء اختيار صورة الإيصال أولاً';
          return;
        }
        btnSend.disabled = true;
        btnSend.textContent = 'جاري الرفع...';
        msg.textContent = '';

        try {
          const file = inputFile.files[0];
          const base64 = await readFileAsBase64(file);

          const uploadPayload = { action: 'uploadMedia', fileName: file.name, mimeType: file.type, fileData: base64, placeId: placeId || '' };
          const uploadResp = await apiPost(uploadPayload);
          if (!uploadResp.ok) throw new Error('فشل رفع الملف');
          const upData = uploadResp.data && uploadResp.data.data ? uploadResp.data.data : uploadResp.data;
          const fileUrl = (upData && (upData.fileUrl || upData.url)) || uploadResp.fileUrl || (uploadResp.data && uploadResp.data.fileUrl) || '';
          if (!fileUrl) throw new Error('لم يتم الحصول على رابط الملف بعد الرفع');

          if (paymentId) {
            const updatePayload = {
              action: 'updatePaymentRequest',
              paymentId: paymentId,
              updates: { 'رابط إيصال الدفع': fileUrl, receiptUrl: fileUrl, الحالة: 'receipt_uploaded', ملاحظات: 'تم رفع إيصال من صاحب المحل' }
            };
            const updateResp = await apiPost(updatePayload);
            if (!updateResp.ok) throw new Error('تم رفع الإيصال لكن فشل ربطه بطلب الدفع.');
          }

          msg.textContent = 'تم إرسال الإيصال بنجاح. سيتم التحقق.';
          setTimeout(() => modal.remove(), 1200);
        } catch (err) {
          msg.textContent = 'حدث خطأ أثناء الإرسال: ' + (err.message || err);
          btnSend.disabled = false;
          btnSend.textContent = 'أرسل الإيصال';
        }
      });
    }

    async function tryPrefillPlaceForm(place) {
      if (!place || !place.raw) return;
      try {
        const raw = place.raw;
        const setInput = (selector, value) => { const el = document.querySelector(selector); if (el && (value !== undefined && value !== null)) el.value = value; };

        const name = raw['اسم المكان'] || place.name || '';
        setInput('input[name="placeName"]', name);
        setInput('input[name="password"]', raw['كلمة المرور'] || place.password || '');
        setInput('input[name="detailedAddress"]', raw['العنوان التفصيلي'] || '');
        setInput('input[name="mapLink"]', raw['رابط الموقع على الخريطة'] || '');
        setInput('input[name="phone"]', raw['رقم التواصل'] || '');
        setInput('input[name="whatsappLink"]', raw['رابط واتساب'] || '');
        setInput('input[name="email"]', raw['البريد الإلكتروني'] || '');
        setInput('input[name="website"]', raw['الموقع الالكتروني'] || '');
        setInput('input[name="workingHours"]', raw['ساعات العمل'] || '');
        setInput('textarea[name="description"]', raw['وصف مختصر '] || '');
        await setSelectValueWhenReady('select[name="activityType"]', raw['نوع النشاط / الفئة'] || '');
        await setSelectValueWhenReady('select[name="city"]', raw['المدينة'] || '');
        if ((raw['المدينة'] || '') !== '') updateAreas();
        await setSelectValueWhenReady('select[name="area"]', raw['المنطقة'] || '');
        await setSelectValueWhenReady('select[name="location"]', raw['الموقع او المول'] || '');

        const logoUrl = raw['رابط صورة شعار المكان'] || raw['صورة شعار أو صورة المكان'] || '';
        if (logoUrl) {
          const preview = document.getElementById('placeImagePreview');
          if (preview) { preview.innerHTML = ''; const img = document.createElement('img'); img.src = logoUrl; preview.appendChild(img); }
        }
      } catch {}
    }

    function escapeHtml(s) {
      if (s === null || s === undefined) return '';
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
  </script>
</body>
</html>
